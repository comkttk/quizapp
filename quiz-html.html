<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>SMART-EDUCATION/JS Conversion</title>
    <style>
        :root {
            --accent: #2b6cb0;
            --danger: #e53e3e;
            --ok: #38a169;
        }

        body {
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            margin: 0;
            padding: 20px;
            background: #f7fafc;
            color: #1a202c
        }

        .wrap {
            max-width: 920px;
            margin: 0 auto;
            background: #fff;
            padding: 18px;
            border-radius: 10px;
            box-shadow: 0 6px 20px rgba(2,6,23,0.08)
        }

        h1 {
            margin: 0 0 8px;
            font-size: 20px
        }

        p.lead {
            margin: 0 0 18px;
            color: #4a5568
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 18px
        }

        .panel {
            padding: 12px;
            border-radius: 8px;
            background: #f1f5f9
        }

        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 12px
        }

        button {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #cbd5e1;
            background: #fff;
            cursor: pointer
        }

            button.primary {
                background: var(--accent);
                color: white;
                border-color: transparent
            }

            button.warn {
                background: var(--danger);
                color: white
            }

            button.ok {
                background: var(--ok);
                color: white
            }

            button:disabled {
                opacity: 0.6;
                cursor: not-allowed
            }

        .question-area {
            min-height: 160px;
            display: flex;
            flex-direction: column;
            gap: 12px
        }

        .q-text {
            font-size: 18px;
            padding: 12px;
            border-radius: 8px;
            background: white;
            box-shadow: 0 1px 0 rgba(2,6,23,0.04)
        }

        .options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px
        }

        .opt {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px
        }

            .opt.disabled {
                opacity: 0.6;
                cursor: not-allowed
            }

            .opt.correct {
                background: #c6f6d5;
                border-color: #9ae6b4
            }

            .opt.wrong {
                background: #fed7d7;
                border-color: #f6adad
            }

        .meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 6px
        }

        .timer {
            font-weight: 700
        }

        .progress {
            color: #4a5568
        }

        .side {
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        label {
            font-size: 13px;
            color: #4a5568
        }

        input[type="text"], textarea, input[type="number"] {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #cbd5e1
        }

        textarea {
            min-height: 80px
        }

        .small {
            font-size: 12px;
            color: #718096
        }

        .results {
            margin-top: 12px;
            padding: 10px;
            border-radius: 8px;
            background: #fff
        }

        /* Urdu font fallback - use if installed on user's system */
        .urdu {
            font-family: 'Jameel Noori Nastaleeq', 'Noto Nastaliq Urdu', serif
        }

        footer {
            margin-top: 12px;
            color: #718096;
            font-size: 13px
        }

        @media (max-width:900px) {
            .grid {
                grid-template-columns: 1fr
            }

            .side {
                order: 2
            }
        }
    </style>
</head>
<body>
    <div class="wrap">
        <h1>Smart-Education</h1>
        <p class="lead">Ejaz Academy</p>

        <div class="grid">
            <div>
                <div class="panel">
                    <div class="controls">
                        <input id="fileInput" type="file" accept=".csv" />
                        <button id="loadSample" class="primary">Load sample questions</button>
                        <button id="startBtn" class="ok">Start</button>
                        <button id="pauseBtn">Pause</button>
                        <button id="nextBtn">Next</button>
                        <button id="stopBtn" class="warn">Stop</button>
                        <button id="goToBtn">Go To</button>
                    </div>

                    <div class="question-area">
                        <div id="lblQuestion" class="q-text urdu">(load questions or click "Load sample questions")</div>

                        <div class="options">
                            <div id="opt0" class="opt"><input type="radio" name="opt" id="r0"><label for="r0" id="lbl0"></label></div>
                            <div id="opt1" class="opt"><input type="radio" name="opt" id="r1"><label for="r1" id="lbl1"></label></div>
                            <div id="opt2" class="opt"><input type="radio" name="opt" id="r2"><label for="r2" id="lbl2"></label></div>
                            <div id="opt3" class="opt"><input type="radio" name="opt" id="r3"><label for="r3" id="lbl3"></label></div>
                        </div>

                        <div class="meta">
                            <div class="timer" id="lblTimer">Time: -</div>
                            <div class="progress" id="lblProgress">Question - of -</div>
                        </div>

                    </div>
                </div>

                <div class="results" id="resultsBox" style="display:none">
                    <div><strong>Results</strong></div>
                    <div id="resultText" style="margin-top:8px"></div>
                    <div style="margin-top:8px">
                        <button id="downloadResults">Download Results CSV</button>
                        <button id="closeResults">Close</button>
                    </div>
                </div>

            </div>

            <aside class="side">
                <div class="panel">
                    <label>Name</label>
                    <input type="text" id="txtName" placeholder="Enter user name (optional)" />

                    <label>Per-question time limit (seconds)</label>
                    <input type="number" id="timeLimitInput" min="3" value="15" />

                    <label>Or paste CSV (first line = header). Columns: question,opt1,opt2,opt3,opt4,correct</label>
                    <textarea id="csvPaste" placeholder="question,opt1,opt2,opt3,opt4,correct\nWhat is 2+2?,1,2,3,4,4"></textarea>
                    <div style="display:flex;gap:6px;margin-top:6px">
                        <button id="pasteLoad">Load from paste</button>
                        <button id="clearStorage">Clear saved results</button>
                    </div>

                    <div style="margin-top:10px" class="small">
                        <strong>Notes:</strong>
                        <ul>
                            <li>The "correct" column accepts: 1/2/3/4 or a/b/c/d or words like "one" or the exact option text.</li>
                            <li>If you don't load questions, use "Load sample questions".</li>
                            <li>Options are disabled until you press Start.</li>
                        </ul>
                    </div>
                </div>

                <div class="panel">
                    <div><strong>Saved attempts (localStorage)</strong></div>
                    <div id="savedCount" class="small" style="margin-top:6px">0 saved attempts</div>
                    <div style="margin-top:6px">
                        <button id="downloadAll">Download all saved</button>
                    </div>
                </div>
            </aside>
        </div>

        <footer>Converted from VBA by this tool. If you want a version that writes directly to Google Sheets or server-side storage, tell me and I'll add it.</footer>
    </div>

    <script>
        // --- state ---
        let questions = []; // each: {q, opts:[], correctRaw}
        let currentQuestionIndex = 0; // 0-based
        let totalQuestions = 0;
        let secondsLeft = 0;
        let timeLimit = 15;
        let correctCount = 0;
        let wrongCount = 0;
        let isLocked = false;
        let quizStarted = false;
        let isPaused = false;
        let skippedQuestionsCount = 0;
        let timerId = null;

        // --- helpers ---
        function $(id) { return document.getElementById(id) }
        function clamp(v, a, b) { return Math.max(a, Math.min(b, v)) }

        function csvToArray(text) {
            // Simple CSV parser that supports quoted fields and commas inside quotes
            const rows = [];
            const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
            for (const line of lines) {
                const row = [];
                let inQuotes = false;
                let cur = '';
                for (let i = 0; i < line.length; i++) {
                    const ch = line[i];
                    if (ch === '"') {
                        if (inQuotes && line[i + 1] === '"') { cur += '"'; i++; } else { inQuotes = !inQuotes; }
                    } else if (ch === ',' && !inQuotes) { row.push(cur); cur = ''; }
                    else cur += ch;
                }
                row.push(cur);
                rows.push(row.map(c => c.trim()));
            }
            return rows;
        }

        function parseCorrectOptionFromQuestionData(raw, opts) {
            if (!raw) return -1;
            const r = String(raw).trim().toLowerCase();
            if (r === '') return -1;
            // numeric
            if (/^\d+$/.test(r)) {
                const n = parseInt(r, 10);
                if (n >= 1 && n <= 4) return n - 1;
            }
            // single letter
            if (r.length === 1) {
                const map = { 'a': 0, 'b': 1, 'c': 2, 'd': 3 };
                if (map.hasOwnProperty(r)) return map[r];
            }
            // words
            if (r.includes('one')) return 0;
            if (r.includes('two')) return 1;
            if (r.includes('three')) return 2;
            if (r.includes('four')) return 3;
            // exact match to option text
            for (let i = 0; i < 4; i++) {
                if (!opts[i]) continue;
                const o = String(opts[i]).trim().toLowerCase();
                if (o === r) return i;
                if (o.includes(r) || r.includes(o)) return i;
            }
            // contains digit
            for (let i = 0; i < 4; i++) if (r.includes(String(i + 1))) return i;
            return -1;
        }

        // --- UI ---
        function setOptionsEnabled(enabled) {
            for (let i = 0; i < 4; i++) {
                const el = $('opt' + i);
                if (enabled) el.classList.remove('disabled'); else el.classList.add('disabled');
            }
            const radios = document.querySelectorAll('input[name="opt"]');
            radios.forEach(r => r.disabled = !enabled);
        }

        function resetOptionStyles() {
            for (let i = 0; i < 4; i++) {
                const el = $('opt' + i);
                el.classList.remove('correct', 'wrong');
                const lbl = $('lbl' + i);
                lbl.style.pointerEvents = 'auto';
            }
        }

        function showQuestion(index) {
            isLocked = false;
            if (index < 0 || index >= totalQuestions) return;
            stopQuizTimer();
            const q = questions[index];
            $('lblQuestion').textContent = q.q || '(no question)';
            for (let i = 0; i < 4; i++) {
                $('lbl' + i).textContent = q.opts[i] || '';
                $('r' + i).checked = false;
            }
            resetOptionStyles();
            setOptionsEnabled(quizStarted);
            timeLimit = parseInt($('timeLimitInput').value || '15', 10);
            secondsLeft = timeLimit;
            $('lblTimer').textContent = 'Time: ' + secondsLeft + ' sec';
            $('lblProgress').textContent = 'Question ' + (currentQuestionIndex + 1) + ' of ' + totalQuestions;
            if (quizStarted && !isPaused) startQuizTimer();
        }

        function startQuizTimer() {
            stopQuizTimer();
            timerId = setInterval(() => {
                timerTickFromModule();
            }, 1000);
        }
        function stopQuizTimer() { if (timerId) { clearInterval(timerId); timerId = null; } }

        function timerTickFromModule() {
            if (isLocked) return;
            secondsLeft--;
            if (secondsLeft <= 0) {
                $('lblTimer').textContent = 'Time: 0 sec';
                stopQuizTimer();
                evaluateAnswer(-1); // 0 in VBA = timeout; here -1 means no selection
            } else {
                $('lblTimer').textContent = 'Time: ' + secondsLeft + ' sec';
            }
        }

        function evaluateAnswer(selectedIndex) {
            if (isLocked) return;
            isLocked = true;
            stopQuizTimer();
            const q = questions[currentQuestionIndex];
            const correctIndex = parseCorrectOptionFromQuestionData(q.correctRaw, q.opts);

            // Highlight correct
            if (correctIndex >= 0) $('opt' + correctIndex).classList.add('correct');

            // If wrong
            if (selectedIndex >= 0 && selectedIndex !== correctIndex) {
                $('opt' + selectedIndex).classList.add('wrong');
            }

            // Count
            if (selectedIndex >= 0 && selectedIndex === correctIndex) {
                correctCount++;
            } else if (selectedIndex >= 0 && selectedIndex !== correctIndex) {
                wrongCount++;
            } else if (selectedIndex === -1) {
                // timed out, count as wrong
                wrongCount++;
            }

            // Pause for 2 seconds then next
            setTimeout(() => {
                nextQuestion();
            }, 2000);
        }

        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex >= totalQuestions) {
                stopQuizTimer();
                quizStarted = false;
                showResults('Quiz Completed!');
            } else {
                showQuestion(currentQuestionIndex);
            }
        }

        function showResults(title) {
            $('resultsBox').style.display = 'block';
            const attempted = correctCount + wrongCount;
            const txt = `<div>${title}</div>\n<div style=\"margin-top:6px\">Correct answers: ${correctCount}</div>\n<div>Wrong answers: ${wrongCount}</div>\n<div>Attempted: ${attempted}</div>\n<div>Skipped: ${skippedQuestionsCount}</div>\n<div>Total Questions: ${totalQuestions}</div>`;
            $('resultText').innerHTML = txt;
            saveResultToLocal();
        }

        function saveResultToLocal() {
            const name = ($('txtName').value || 'Unknown').trim();
            const attempted = correctCount + wrongCount;
            const rec = { name, correct: correctCount, wrong: wrongCount, attempted, skipped: skippedQuestionsCount, total: totalQuestions, date: new Date().toISOString() };
            const key = 'quiz_attempts_v1';
            const arr = JSON.parse(localStorage.getItem(key) || '[]');
            arr.push(rec);
            localStorage.setItem(key, JSON.stringify(arr));
            updateSavedCount();
        }

        function updateSavedCount() {
            const arr = JSON.parse(localStorage.getItem('quiz_attempts_v1') || '[]');
            $('savedCount').textContent = arr.length + ' saved attempts';
        }

        function downloadCSV(records, filename) {
            if (!records || records.length === 0) { alert('No records to download'); return; }
            const header = ['Name', 'Correct Questions', 'Wrong Questions', 'Attempted Questions', 'Skipped Questions', 'Total Questions', 'Date & Time'];
            const rows = [header.join(',')];
            for (const r of records) {
                rows.push([escapeCSV(r.name), r.correct, r.wrong, r.attempted, r.skipped, r.total, r.date].join(','));
            }
            const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = filename || 'results.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        }
        function escapeCSV(v) { if (v == null) return ''; return '"' + String(v).replace(/"/g, '""') + '"'; }

        // --- events ---
        window.addEventListener('DOMContentLoaded', () => {
            // attach handlers
            $('loadSample').addEventListener('click', () => {
                loadSampleQuestions();
            });
            $('startBtn').addEventListener('click', () => {
                if (quizStarted) return;
                if (questions.length === 0) { alert('Load questions first (CSV/paste or sample)'); return; }
                quizStarted = true; correctCount = 0; wrongCount = 0; skippedQuestionsCount = 0; currentQuestionIndex = 0;
                $('startBtn').disabled = true; $('txtName').disabled = true;
                setOptionsEnabled(true);
                showQuestion(currentQuestionIndex);
            });

            $('pauseBtn').addEventListener('click', () => {
                if (!quizStarted) return;
                if (isPaused) { // resume
                    isPaused = false; $('pauseBtn').textContent = 'Pause'; $('pauseBtn').classList.remove('ok'); startQuizTimer();
                } else { // pause
                    isPaused = true; $('pauseBtn').textContent = 'Play'; $('pauseBtn').classList.add('ok'); stopQuizTimer();
                }
            });

            $('nextBtn').addEventListener('click', () => {
                // if currently paused and pause button shows Play (i.e. isPaused true) then resume (mimic VBA behavior)
                if (isPaused) { isPaused = false; $('pauseBtn').textContent = 'Pause'; $('pauseBtn').classList.remove('ok'); startQuizTimer(); }
                skippedQuestionsCount++;
                // Immediately move to next without counting an attempt
                stopQuizTimer();
                currentQuestionIndex++;
                if (currentQuestionIndex >= totalQuestions) { showResults('Quiz Completed!'); } else showQuestion(currentQuestionIndex);
            });

            $('stopBtn').addEventListener('click', () => {
                stopQuizTimer(); quizStarted = false; $('startBtn').disabled = false; $('txtName').disabled = false; setOptionsEnabled(false);
                showResults('Quiz Stopped!');
            });

            $('goToBtn').addEventListener('click', () => {
                const v = prompt('Enter question number to go to:');
                if (!v) return; const qn = parseInt(v, 10);
                if (isNaN(qn) || qn < 1 || qn > totalQuestions) { alert('Invalid question number'); return; }
                currentQuestionIndex = qn - 1; showQuestion(currentQuestionIndex);
                if (isPaused) { isPaused = false; $('pauseBtn').textContent = 'Pause'; $('pauseBtn').classList.remove('ok'); }
            });

            for (let i = 0; i < 4; i++) {
                $('opt' + i).addEventListener('click', () => {
                    if (!quizStarted || isLocked || isPaused) return; // disabled until start
                    checkAndSetPauseButton();
                    // mark selected visually
                    document.querySelectorAll('.opt').forEach(el => el.classList.remove('selected'));
                    $('opt' + i).classList.add('selected');
                    evaluateAnswer(i);
                });
            }

            $('fileInput').addEventListener('change', (ev) => {
                const f = ev.target.files[0]; if (!f) return;
                const reader = new FileReader();
                reader.onload = e => {
                    loadQuestionsFromCSV(e.target.result);
                };
                reader.readAsText(f);
            });

            $('pasteLoad').addEventListener('click', () => {
                const t = $('csvPaste').value.trim(); if (!t) { alert('Paste some CSV first'); return; }
                loadQuestionsFromCSV(t);
            });

            $('clearStorage').addEventListener('click', () => {
                if (confirm('Clear all saved results in localStorage?')) { localStorage.removeItem('quiz_attempts_v1'); updateSavedCount(); }
            });

            $('downloadAll').addEventListener('click', () => {
                const arr = JSON.parse(localStorage.getItem('quiz_attempts_v1') || '[]');
                if (arr.length === 0) return alert('No saved attempts');
                downloadCSV(arr, 'all_quiz_attempts.csv');
            });

            $('downloadResults').addEventListener('click', () => {
                const arr = JSON.parse(localStorage.getItem('quiz_attempts_v1') || '[]');
                if (arr.length === 0) return alert('No saved attempts');
                downloadCSV(arr, 'quiz_results.csv');
            });

            $('closeResults').addEventListener('click', () => { $('resultsBox').style.display = 'none'; $('startBtn').disabled = false; $('txtName').disabled = false; });

            // set initial
            setOptionsEnabled(false);
            updateSavedCount();
            // load an example automatically
            loadSampleQuestions();
        });

        function checkAndSetPauseButton() {
            if (isPaused) { isPaused = false; $('pauseBtn').textContent = 'Pause'; $('pauseBtn').classList.remove('ok'); startQuizTimer(); }
        }

        function loadQuestionsFromCSV(text) {
            try {
                const rows = csvToArray(text);
                if (rows.length === 0) { alert('No rows found'); return; }
                // detect header
                let start = 0;
                const first = rows[0].map(c => c.toLowerCase());
                if (first.includes('question') || first.includes('opt1') || first.includes('option1')) start = 1;
                const arr = [];
                for (let i = start; i < rows.length; i++) {
                    const r = rows[i];
                    const q = r[0] || '';
                    const opts = [r[1] || '', r[2] || '', r[3] || '', r[4] || ''];
                    const correctRaw = r[5] || '';
                    arr.push({ q, opts, correctRaw });
                }
                questions = arr; totalQuestions = questions.length; currentQuestionIndex = 0;
                alert('Loaded ' + totalQuestions + ' questions');
                showQuestion(currentQuestionIndex);
            } catch (e) { console.error(e); alert('Failed to parse CSV: ' + e.message); }
        }

        function loadSampleQuestions() {
            questions = [
                { q: 'What is 2 + 2?', opts: ['1', '2', '3', '4'], correctRaw: '4' },
                { q: 'Which is a fruit?', opts: ['Carrot', 'Apple', 'Potato', 'Onion'], correctRaw: 'b' },
                { q: 'Select the color of sky', opts: ['Blue', 'Green', 'Red', 'Black'], correctRaw: 'Blue' },
                { q: 'اردو میں سلام کس طرح کہتے ہیں؟', opts: ['Hello', 'Salam', 'Good', 'Fine'], correctRaw: 'Salam' }
            ];
            totalQuestions = questions.length; currentQuestionIndex = 0; showQuestion(currentQuestionIndex);
        }

    </script>
</body>
</html>
<script>
    window.addEventListener('load', () => {
        fetch('questions.csv')
            .then(response => response.text())
            .then(csvText => {
                loadCSV(csvText); // Call your CSV loading function
                alert('Questions loaded automatically!');
            })
            .catch(error => console.error('Could not auto-load CSV:', error));
    });
</script>
